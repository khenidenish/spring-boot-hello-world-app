pipeline {
    agent any

    environment {
        AWS_REGION = 'ap-southeast-1'
        ECR_REPOSITORY = 'spring-boot-demo'
        DOCKER_IMAGE_TAG = "${env.BUILD_NUMBER}"
        K8S_NAMESPACE = 'dev'
        K8S_DEPLOYMENT_NAME = 'my-app'
    }

    stages {
        
        stage('Deploy') {
            steps {
                // Deploy the Docker image to Kubernetes
                script {
                    withKubeConfig([credentialsId: 'kubeconfig-credential', serverUrl: 'https://7E0DFEB26D957EB7CA7980D91D2B11C2.gr7.ap-southeast-1.eks.amazonaws.com'])
                    {
                        sh '''
                            kubectl set image deployment/${K8S_DEPLOYMENT_NAME} ${K8S_DEPLOYMENT_NAME}=${ECR_REPOSITORY}:${DOCKER_IMAGE_TAG} -n ${K8S_NAMESPACE} --kubeconfig=$KUBECONFIG
                        '''
                    }
                }
            }
        }
    }
    
}
